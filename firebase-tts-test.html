<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase TTS æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }

      .container {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      button {
        background: #4285f4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background: #3367d6;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
      }

      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }

      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”¥ Firebase Functions TTS æ¸¬è©¦</h1>

    <div class="container">
      <h3>é…ç½®æª¢æŸ¥</h3>
      <div id="config-status" class="status info">
        å°ˆæ¡ˆ ID: japanese-vocab-game<br />
        Functions URL:
        https://us-central1-japanese-vocab-game.cloudfunctions.net
      </div>
    </div>

    <div class="container">
      <h3>æœå‹™ç‹€æ…‹æª¢æŸ¥</h3>
      <button onclick="checkHealth()">æª¢æŸ¥å¥åº·ç‹€æ…‹</button>
      <button onclick="getSpeakers()">ç²å–èªªè©±è€…åˆ—è¡¨</button>
      <div id="health-status" class="status"></div>
    </div>

    <div class="container">
      <h3>èªéŸ³æ¸¬è©¦</h3>
      <input
        type="text"
        id="textInput"
        placeholder="è¼¸å…¥è¦æœ—è®€çš„æ—¥æ–‡æ–‡å­—"
        value="ã“ã‚“ã«ã¡ã¯"
      />
      <br />
      <label
        >èªªè©±è€…:
        <select id="speakerSelect">
          <option value="1">å¥³æ€§è²éŸ³ 1 (Standard-A)</option>
          <option value="2">ç”·æ€§è²éŸ³ 1 (Standard-B)</option>
          <option value="3">å¥³æ€§è²éŸ³ 2 (Standard-C)</option>
          <option value="4">ç”·æ€§è²éŸ³ 2 (Standard-D)</option>
          <option value="5">é«˜å“è³ªå¥³è² 1 (Wavenet-A)</option>
          <option value="6">é«˜å“è³ªç”·è² 1 (Wavenet-B)</option>
          <option value="7">é«˜å“è³ªå¥³è² 2 (Wavenet-C)</option>
          <option value="8">é«˜å“è³ªç”·è² 2 (Wavenet-D)</option>
        </select>
      </label>
      <br /><br />
      <button onclick="testSpeak()">ğŸ¤ æ¸¬è©¦èªéŸ³åˆæˆ</button>
      <button onclick="testDirectAPI()">ğŸ”§ ç›´æ¥æ¸¬è©¦ API</button>
      <div id="speech-status" class="status"></div>
    </div>

    <div class="container">
      <h3>å¿«å–ç®¡ç†</h3>
      <button onclick="showCache()">é¡¯ç¤ºå¿«å–</button>
      <button onclick="clearCache()">æ¸…ç†å¿«å–</button>
      <div id="cache-status" class="status"></div>
    </div>

    <script type="module">
      // Firebase TTS é¡åˆ¥ï¼ˆç°¡åŒ–ç‰ˆæœ¬ç”¨æ–¼æ¸¬è©¦ï¼‰
      class FirebaseTTS {
        constructor() {
          this.baseURL =
            "https://us-central1-japanese-vocab-game.cloudfunctions.net";
          this.audioCache = new Map();
          this.isServiceAvailable = false;
        }

        async checkService() {
          try {
            const response = await fetch(`${this.baseURL}/health`, {
              method: "GET",
              signal: AbortSignal.timeout(10000),
            });
            this.isServiceAvailable = response.ok;
            return {
              ok: response.ok,
              status: response.status,
              statusText: response.statusText,
            };
          } catch (error) {
            this.isServiceAvailable = false;
            return { ok: false, error: error.message };
          }
        }

        async getSpeakers() {
          try {
            const response = await fetch(`${this.baseURL}/getSpeakers`);
            if (response.ok) {
              return await response.json();
            } else {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
          } catch (error) {
            throw error;
          }
        }

        async speak(text, speaker = 1) {
          const cacheKey = `firebase_${text}_${speaker}`;

          if (this.audioCache.has(cacheKey)) {
            console.log("ğŸµ ä½¿ç”¨å¿«å–èªéŸ³");
            return this.playAudio(this.audioCache.get(cacheKey));
          }

          try {
            const response = await fetch(`${this.baseURL}/speak`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text, speaker }),
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(
                `HTTP ${response.status}: ${
                  errorData.error || response.statusText
                }`
              );
            }

            const audioBlob = await response.blob();
            this.audioCache.set(cacheKey, audioBlob);
            return this.playAudio(audioBlob);
          } catch (error) {
            throw error;
          }
        }

        playAudio(audioBlob) {
          return new Promise((resolve, reject) => {
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);

            audio.onended = () => {
              URL.revokeObjectURL(audioUrl);
              resolve();
            };

            audio.onerror = () => {
              URL.revokeObjectURL(audioUrl);
              reject(new Error("éŸ³é »æ’­æ”¾å¤±æ•—"));
            };

            audio.play().catch(reject);
          });
        }

        getCacheInfo() {
          return {
            size: this.audioCache.size,
            keys: Array.from(this.audioCache.keys()),
          };
        }

        clearCache() {
          this.audioCache.clear();
        }
      }

      // å…¨åŸŸè®Šæ•¸
      window.firebaseTTS = new FirebaseTTS();

      // æ¸¬è©¦å‡½æ•¸
      window.checkHealth = async function () {
        const statusDiv = document.getElementById("health-status");
        statusDiv.textContent = "æª¢æŸ¥ä¸­...";
        statusDiv.className = "status info";

        try {
          const result = await window.firebaseTTS.checkService();
          if (result.ok) {
            statusDiv.textContent = "âœ… Firebase Functions æœå‹™æ­£å¸¸é‹è¡Œ";
            statusDiv.className = "status success";
          } else {
            statusDiv.textContent = `âŒ æœå‹™ä¸å¯ç”¨: HTTP ${result.status} - ${result.statusText}`;
            statusDiv.className = "status error";
          }
        } catch (error) {
          statusDiv.textContent = `âŒ é€£ç·šéŒ¯èª¤: ${error.message}`;
          statusDiv.className = "status error";
        }
      };

      window.getSpeakers = async function () {
        const statusDiv = document.getElementById("health-status");
        statusDiv.textContent = "ç²å–èªªè©±è€…åˆ—è¡¨...";
        statusDiv.className = "status info";

        try {
          const speakers = await window.firebaseTTS.getSpeakers();
          statusDiv.innerHTML =
            `âœ… æ‰¾åˆ° ${speakers.length} å€‹èªªè©±è€…:<br>` +
            speakers
              .map((s) => `${s.id}: ${s.displayName} (${s.name})`)
              .join("<br>");
          statusDiv.className = "status success";
        } catch (error) {
          statusDiv.textContent = `âŒ ç„¡æ³•ç²å–èªªè©±è€…åˆ—è¡¨: ${error.message}`;
          statusDiv.className = "status error";
        }
      };

      window.testSpeak = async function () {
        const text = document.getElementById("textInput").value;
        const speaker = parseInt(
          document.getElementById("speakerSelect").value
        );
        const statusDiv = document.getElementById("speech-status");

        if (!text.trim()) {
          statusDiv.textContent = "è«‹è¼¸å…¥è¦æœ—è®€çš„æ–‡å­—";
          statusDiv.className = "status error";
          return;
        }

        statusDiv.textContent = `ğŸ¤ æ­£åœ¨åˆæˆèªéŸ³: "${text}" (èªªè©±è€…: ${speaker})`;
        statusDiv.className = "status info";

        try {
          await window.firebaseTTS.speak(text, speaker);
          statusDiv.textContent = `âœ… èªéŸ³æ’­æ”¾å®Œæˆ`;
          statusDiv.className = "status success";
        } catch (error) {
          statusDiv.textContent = `âŒ èªéŸ³åˆæˆå¤±æ•—: ${error.message}`;
          statusDiv.className = "status error";
        }
      };

      window.testDirectAPI = async function () {
        const text = document.getElementById("textInput").value;
        const speaker = parseInt(
          document.getElementById("speakerSelect").value
        );
        const statusDiv = document.getElementById("speech-status");

        statusDiv.textContent = "ğŸ”§ ç›´æ¥æ¸¬è©¦ API...";
        statusDiv.className = "status info";

        try {
          const response = await fetch(
            "https://us-central1-japanese-vocab-game.cloudfunctions.net/speak",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text, speaker }),
            }
          );

          if (response.ok) {
            const blob = await response.blob();
            statusDiv.textContent = `âœ… API å›æ‡‰æ­£å¸¸ (${blob.size} bytes)`;
            statusDiv.className = "status success";

            // æ’­æ”¾éŸ³é »
            const audio = new Audio(URL.createObjectURL(blob));
            audio.play();
          } else {
            const errorText = await response.text();
            statusDiv.textContent = `âŒ API éŒ¯èª¤: HTTP ${response.status} - ${errorText}`;
            statusDiv.className = "status error";
          }
        } catch (error) {
          statusDiv.textContent = `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`;
          statusDiv.className = "status error";
        }
      };

      window.showCache = function () {
        const cache = window.firebaseTTS.getCacheInfo();
        const statusDiv = document.getElementById("cache-status");
        statusDiv.innerHTML =
          `å¿«å–å¤§å°: ${cache.size}<br>` +
          (cache.keys.length > 0
            ? `å¿«å–é …ç›®:<br>${cache.keys.join("<br>")}`
            : "ç„¡å¿«å–é …ç›®");
        statusDiv.className = "status info";
      };

      window.clearCache = function () {
        window.firebaseTTS.clearCache();
        const statusDiv = document.getElementById("cache-status");
        statusDiv.textContent = "âœ… å¿«å–å·²æ¸…ç†";
        statusDiv.className = "status success";
      };
    </script>
  </body>
</html>
