<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VOICEVOX æ•´åˆæ¸¬è©¦</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border-left: 4px solid #007acc;
        background-color: #f8f9fa;
      }
      button {
        background-color: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background-color: #005a9e;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .log {
        background-color: #000;
        color: #00ff00;
        padding: 15px;
        border-radius: 5px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      input[type="text"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 200px;
        margin: 5px;
      }
      select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸŒ VOICEVOX æ•´åˆæ¸¬è©¦</h1>

      <div class="test-section">
        <h3>ğŸ”§ ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h3>
        <button onclick="checkSystemStatus()">æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
        <button onclick="checkVoicevoxEngine()">æ¸¬è©¦ VOICEVOX å¼•æ“</button>
        <button onclick="getSpeakers()">ç²å–èªªè©±è€…åˆ—è¡¨</button>
        <div id="systemStatus"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ¤ èªéŸ³åˆæˆæ¸¬è©¦</h3>
        <div>
          <input
            type="text"
            id="testText"
            value="ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œ"
            placeholder="è¼¸å…¥æ—¥æ–‡æ–‡å­—"
          />
          <select id="speakerSelect">
            <option value="1">å››åœ‹ã‚ãŸã‚“ (æ¸…æ™°)</option>
            <option value="2">ãšã‚“ã ã‚‚ã‚“ (å¯æ„›)</option>
            <option value="3">æ˜¥æ—¥éƒ¨ã¤ã‚€ã (æº«å’Œ)</option>
          </select>
          <button onclick="testVoicevoxSynthesis()">åˆæˆèªéŸ³</button>
          <button onclick="testGameUtilsSpeak()">æ¸¬è©¦éŠæˆ²èªéŸ³</button>
        </div>
        <div>
          <label>èªé€Ÿ: </label>
          <input
            type="range"
            id="speedScale"
            min="0.5"
            max="2.0"
            step="0.1"
            value="0.9"
          />
          <span id="speedValue">0.9</span>
        </div>
        <div id="synthesisStatus"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ® éŠæˆ²æ•´åˆæ¸¬è©¦</h3>
        <button onclick="testGameScenario()">æ¸¬è©¦éŠæˆ²å ´æ™¯</button>
        <button onclick="testMultipleWords()">æ¸¬è©¦å¤šå€‹å–®å­—</button>
        <button onclick="clearAllCaches()">æ¸…é™¤æ‰€æœ‰å¿«å–</button>
        <div id="gameTestStatus"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ“Š æ•ˆèƒ½æ¸¬è©¦</h3>
        <button onclick="testPerformance()">æ•ˆèƒ½æ¸¬è©¦</button>
        <button onclick="testCacheEfficiency()">å¿«å–æ•ˆç‡æ¸¬è©¦</button>
        <div id="performanceStatus"></div>
      </div>

      <div id="consoleLog" class="log"></div>
    </div>

    <script type="module">
      // é‡å¯« console.log ä»¥é¡¯ç¤ºåœ¨é é¢ä¸Š
      const originalLog = console.log;
      const originalError = console.error;
      const originalWarn = console.warn;

      function addLogEntry(message, type = "log") {
        const logDiv = document.getElementById("consoleLog");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      console.log = function (...args) {
        originalLog.apply(console, args);
        addLogEntry(args.join(" "), "log");
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        addLogEntry("âŒ " + args.join(" "), "error");
      };

      console.warn = function (...args) {
        originalWarn.apply(console, args);
        addLogEntry("âš ï¸ " + args.join(" "), "warn");
      };

      // è¨­å®šç’°å¢ƒè®Šæ•¸ (æ¨¡æ“¬)
      window.process = {
        env: {
          REACT_APP_VOICEVOX_URL:
            "https://voicevox-engine-hxexk2zeca-de.a.run.app",
          REACT_APP_VOICEVOX_TIMEOUT: "5000",
          REACT_APP_VOICE_CACHE_SIZE: "50",
          REACT_APP_TTS_PRIORITY: "voicevox,firebase,webspeech",
        },
      };

      // å‹•æ…‹è¼‰å…¥æ¨¡çµ„ (åœ¨å¯¦éš›å°ˆæ¡ˆä¸­é€™äº›æœƒæ˜¯æ­£å¸¸çš„ import)
      let VoicevoxTTS, gameUtils, voiceManager;

      try {
        // é€™è£¡éœ€è¦ä½ æ ¹æ“šå¯¦éš›çš„æª”æ¡ˆè·¯å¾‘èª¿æ•´
        // åœ¨å¯¦éš›å°ˆæ¡ˆä¸­ï¼Œé€™äº›æœƒæ˜¯:
        // import VoicevoxTTS from './src/utils/voicevoxEngine.js';
        // import { speak } from './src/utils/gameUtils.js';
        console.log("ğŸ”„ æ­£åœ¨è¼‰å…¥ VOICEVOX æ¨¡çµ„...");

        // æ¨¡æ“¬è¼‰å…¥ - åœ¨å¯¦éš›ä½¿ç”¨æ™‚éœ€è¦æ›¿æ›ç‚ºçœŸå¯¦çš„ import
        console.log("âœ… æ¨¡çµ„è¼‰å…¥å®Œæˆ (æ¨¡æ“¬)");
        console.log("â„¹ï¸ åœ¨å¯¦éš›å°ˆæ¡ˆä¸­ï¼Œè«‹ç¢ºä¿æ­£ç¢º import ç›¸é—œæ¨¡çµ„");
      } catch (error) {
        console.error("âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—:", error);
      }

      // æ¸¬è©¦å‡½æ•¸
      window.checkSystemStatus = async function () {
        const statusDiv = document.getElementById("systemStatus");
        statusDiv.innerHTML =
          '<div class="status info">æ­£åœ¨æª¢æŸ¥ç³»çµ±ç‹€æ…‹...</div>';

        try {
          const status = {
            voicevoxUrl: window.process.env.REACT_APP_VOICEVOX_URL,
            timeout: window.process.env.REACT_APP_VOICEVOX_TIMEOUT,
            cacheSize: window.process.env.REACT_APP_VOICE_CACHE_SIZE,
            priority: window.process.env.REACT_APP_TTS_PRIORITY,
          };

          console.log("ğŸ”§ ç³»çµ±é…ç½®:", status);

          statusDiv.innerHTML = `
                    <div class="status success">
                        <strong>ç³»çµ±é…ç½®æ­£å¸¸</strong><br>
                        VOICEVOX URL: ${status.voicevoxUrl}<br>
                        è¶…æ™‚è¨­å®š: ${status.timeout}ms<br>
                        å¿«å–å¤§å°: ${status.cacheSize}<br>
                        TTS å„ªå…ˆé †åº: ${status.priority}
                    </div>
                `;
        } catch (error) {
          console.error("ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—:", error);
          statusDiv.innerHTML = `<div class="status error">ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}</div>`;
        }
      };

      window.checkVoicevoxEngine = async function () {
        const statusDiv = document.getElementById("systemStatus");

        try {
          console.log("ğŸ§ª æ¸¬è©¦ VOICEVOX å¼•æ“é€£æ¥...");

          const response = await fetch(
            `${window.process.env.REACT_APP_VOICEVOX_URL}/version`,
            {
              method: "GET",
              signal: AbortSignal.timeout(5000),
            }
          );

          if (response.ok) {
            const version = await response.text();
            console.log(`âœ… VOICEVOX å¼•æ“é€£æ¥æˆåŠŸ (ç‰ˆæœ¬: ${version})`);
            statusDiv.innerHTML += `<div class="status success">VOICEVOX å¼•æ“å¯ç”¨ (ç‰ˆæœ¬: ${version})</div>`;
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("âŒ VOICEVOX å¼•æ“é€£æ¥å¤±æ•—:", error);
          statusDiv.innerHTML += `<div class="status error">VOICEVOX å¼•æ“é€£æ¥å¤±æ•—: ${error.message}</div>`;
        }
      };

      window.getSpeakers = async function () {
        const statusDiv = document.getElementById("systemStatus");

        try {
          console.log("ğŸ—£ï¸ ç²å–èªªè©±è€…åˆ—è¡¨...");

          const response = await fetch(
            `${window.process.env.REACT_APP_VOICEVOX_URL}/speakers`,
            {
              method: "GET",
              signal: AbortSignal.timeout(5000),
            }
          );

          if (response.ok) {
            const speakers = await response.json();
            console.log(`âœ… ç²å–åˆ° ${speakers.length} å€‹èªªè©±è€…`);

            // æ›´æ–°èªªè©±è€…é¸æ“‡å™¨
            const speakerSelect = document.getElementById("speakerSelect");
            speakerSelect.innerHTML = "";
            speakers.slice(0, 10).forEach((speaker) => {
              const option = document.createElement("option");
              option.value = speaker.speaker_uuid;
              option.textContent = `${speaker.name} (${
                speaker.styles[0]?.name || "default"
              })`;
              speakerSelect.appendChild(option);
            });

            statusDiv.innerHTML += `<div class="status success">æˆåŠŸç²å– ${speakers.length} å€‹èªªè©±è€…</div>`;
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error("âŒ ç²å–èªªè©±è€…åˆ—è¡¨å¤±æ•—:", error);
          statusDiv.innerHTML += `<div class="status error">ç²å–èªªè©±è€…åˆ—è¡¨å¤±æ•—: ${error.message}</div>`;
        }
      };

      window.testVoicevoxSynthesis = async function () {
        const statusDiv = document.getElementById("synthesisStatus");
        const text = document.getElementById("testText").value;
        const speaker = 1; // å›ºå®šä½¿ç”¨èªªè©±è€… 1
        const speedScale = document.getElementById("speedScale").value;

        if (!text.trim()) {
          statusDiv.innerHTML =
            '<div class="status error">è«‹è¼¸å…¥è¦åˆæˆçš„æ–‡å­—</div>';
          return;
        }

        statusDiv.innerHTML = '<div class="status info">æ­£åœ¨åˆæˆèªéŸ³...</div>';

        try {
          console.log(
            `ğŸ¤ åˆæˆèªéŸ³: "${text}" (èªªè©±è€…: ${speaker}, èªé€Ÿ: ${speedScale})`
          );

          // Step 1: ç”ŸæˆèªéŸ³æŸ¥è©¢
          const encodedText = encodeURIComponent(text);
          const queryResponse = await fetch(
            `${window.process.env.REACT_APP_VOICEVOX_URL}/audio_query?text=${encodedText}&speaker=${speaker}`,
            {
              method: "POST",
              signal: AbortSignal.timeout(5000),
            }
          );

          if (!queryResponse.ok) {
            throw new Error(`èªéŸ³æŸ¥è©¢å¤±æ•—: HTTP ${queryResponse.status}`);
          }

          const audioQuery = await queryResponse.json();
          audioQuery.speedScale = parseFloat(speedScale);

          console.log("âœ… èªéŸ³æŸ¥è©¢ç”ŸæˆæˆåŠŸ");

          // Step 2: åˆæˆèªéŸ³
          const synthesisResponse = await fetch(
            `${window.process.env.REACT_APP_VOICEVOX_URL}/synthesis?speaker=${speaker}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(audioQuery),
              signal: AbortSignal.timeout(10000),
            }
          );

          if (!synthesisResponse.ok) {
            throw new Error(`èªéŸ³åˆæˆå¤±æ•—: HTTP ${synthesisResponse.status}`);
          }

          const audioBlob = await synthesisResponse.blob();
          console.log(`âœ… èªéŸ³åˆæˆæˆåŠŸ (${audioBlob.size} bytes)`);

          // Step 3: æ’­æ”¾èªéŸ³
          const audioURL = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioURL);

          audio.onended = () => {
            URL.revokeObjectURL(audioURL);
            console.log("âœ… èªéŸ³æ’­æ”¾å®Œæˆ");
          };

          audio.onerror = (error) => {
            URL.revokeObjectURL(audioURL);
            console.error("âŒ éŸ³è¨Šæ’­æ”¾éŒ¯èª¤:", error);
          };

          await audio.play();

          statusDiv.innerHTML = `
                    <div class="status success">
                        èªéŸ³åˆæˆä¸¦æ’­æ”¾æˆåŠŸ<br>
                        æ–‡å­—: ${text}<br>
                        æª”æ¡ˆå¤§å°: ${audioBlob.size} bytes<br>
                        èªé€Ÿ: ${speedScale}
                    </div>
                `;
        } catch (error) {
          console.error("âŒ èªéŸ³åˆæˆå¤±æ•—:", error);
          statusDiv.innerHTML = `<div class="status error">èªéŸ³åˆæˆå¤±æ•—: ${error.message}</div>`;
        }
      };

      window.testGameUtilsSpeak = function () {
        const statusDiv = document.getElementById("synthesisStatus");
        statusDiv.innerHTML =
          '<div class="status info">éŠæˆ²èªéŸ³åŠŸèƒ½éœ€è¦åœ¨ React å°ˆæ¡ˆä¸­æ¸¬è©¦</div>';
        console.log("â„¹ï¸ testGameUtilsSpeak éœ€è¦åœ¨å®Œæ•´çš„ React å°ˆæ¡ˆç’°å¢ƒä¸­é‹è¡Œ");
      };

      window.testGameScenario = function () {
        const statusDiv = document.getElementById("gameTestStatus");
        statusDiv.innerHTML =
          '<div class="status info">éŠæˆ²å ´æ™¯æ¸¬è©¦éœ€è¦åœ¨ React å°ˆæ¡ˆä¸­é‹è¡Œ</div>';
        console.log("â„¹ï¸ éŠæˆ²å ´æ™¯æ¸¬è©¦éœ€è¦å®Œæ•´çš„å°ˆæ¡ˆç’°å¢ƒ");
      };

      window.testMultipleWords = async function () {
        const words = [
          "ã“ã‚“ã«ã¡ã¯",
          "ã‚ã‚ŠãŒã¨ã†",
          "ã™ã¿ã¾ã›ã‚“",
          "ãŠã¯ã‚ˆã†",
          "ã•ã‚ˆã†ãªã‚‰",
        ];
        const statusDiv = document.getElementById("gameTestStatus");

        statusDiv.innerHTML =
          '<div class="status info">æ­£åœ¨æ¸¬è©¦å¤šå€‹å–®å­—...</div>';

        let successCount = 0;

        for (const word of words) {
          try {
            console.log(`ğŸ¤ æ¸¬è©¦å–®å­—: ${word}`);

            // ç°¡åŒ–çš„æ¸¬è©¦ - åªæ¸¬è©¦èªéŸ³æŸ¥è©¢
            const encodedText = encodeURIComponent(word);
            const response = await fetch(
              `${window.process.env.REACT_APP_VOICEVOX_URL}/audio_query?text=${encodedText}&speaker=1`,
              {
                method: "POST",
                signal: AbortSignal.timeout(3000),
              }
            );

            if (response.ok) {
              successCount++;
              console.log(`âœ… ${word} - æˆåŠŸ`);
            } else {
              console.log(`âŒ ${word} - å¤±æ•— (HTTP ${response.status})`);
            }
          } catch (error) {
            console.error(`âŒ ${word} - éŒ¯èª¤:`, error.message);
          }

          // çŸ­æš«å»¶é²é¿å…éè¼‰
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        statusDiv.innerHTML = `
                <div class="status ${
                  successCount === words.length ? "success" : "error"
                }">
                    å¤šå–®å­—æ¸¬è©¦å®Œæˆ: ${successCount}/${words.length} æˆåŠŸ
                </div>
            `;
      };

      window.clearAllCaches = function () {
        const statusDiv = document.getElementById("gameTestStatus");
        statusDiv.innerHTML =
          '<div class="status info">å¿«å–æ¸…é™¤åŠŸèƒ½éœ€è¦åœ¨ React å°ˆæ¡ˆä¸­é‹è¡Œ</div>';
        console.log("ğŸ§¹ å¿«å–æ¸…é™¤åŠŸèƒ½éœ€è¦å®Œæ•´çš„å°ˆæ¡ˆç’°å¢ƒ");
      };

      window.testPerformance = async function () {
        const statusDiv = document.getElementById("performanceStatus");
        statusDiv.innerHTML =
          '<div class="status info">æ­£åœ¨é€²è¡Œæ•ˆèƒ½æ¸¬è©¦...</div>';

        const startTime = performance.now();

        try {
          // æ¸¬è©¦ API å›æ‡‰æ™‚é–“
          const response = await fetch(
            `${window.process.env.REACT_APP_VOICEVOX_URL}/version`,
            {
              method: "GET",
              signal: AbortSignal.timeout(5000),
            }
          );

          const endTime = performance.now();
          const responseTime = Math.round(endTime - startTime);

          if (response.ok) {
            console.log(`âš¡ API å›æ‡‰æ™‚é–“: ${responseTime}ms`);

            statusDiv.innerHTML = `
                        <div class="status success">
                            æ•ˆèƒ½æ¸¬è©¦å®Œæˆ<br>
                            API å›æ‡‰æ™‚é–“: ${responseTime}ms<br>
                            ç‹€æ…‹: ${
                              responseTime < 1000
                                ? "å„ªç§€"
                                : responseTime < 3000
                                ? "è‰¯å¥½"
                                : "éœ€è¦å„ªåŒ–"
                            }
                        </div>
                    `;
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          const endTime = performance.now();
          const responseTime = Math.round(endTime - startTime);

          console.error(`âŒ æ•ˆèƒ½æ¸¬è©¦å¤±æ•— (${responseTime}ms):`, error);
          statusDiv.innerHTML = `<div class="status error">æ•ˆèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
        }
      };

      window.testCacheEfficiency = function () {
        const statusDiv = document.getElementById("performanceStatus");
        statusDiv.innerHTML =
          '<div class="status info">å¿«å–æ•ˆç‡æ¸¬è©¦éœ€è¦åœ¨ React å°ˆæ¡ˆä¸­é‹è¡Œ</div>';
        console.log("ğŸ“Š å¿«å–æ•ˆç‡æ¸¬è©¦éœ€è¦å®Œæ•´çš„å°ˆæ¡ˆç’°å¢ƒ");
      };

      // åˆå§‹åŒ–
      document
        .getElementById("speedScale")
        .addEventListener("input", function (e) {
          document.getElementById("speedValue").textContent = e.target.value;
        });

      // è‡ªå‹•æª¢æŸ¥ç³»çµ±ç‹€æ…‹
      setTimeout(() => {
        console.log("ğŸš€ VOICEVOX æ•´åˆæ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ");
        checkSystemStatus();
      }, 1000);
    </script>
  </body>
</html>
